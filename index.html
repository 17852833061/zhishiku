<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>çŸ¥è¯†å†œåœº - å®Œæ•´è¿˜åŸç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@300;400;700&display=swap');
        body { margin: 0; padding: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .paper-texture { background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png"); }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .float-animation { display: inline-block; animation: float 4s ease-in-out infinite; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* è¿˜åŸæ‰¹æ³¨æ ·å¼ */
        .annotation-highlight { background-color: #fef08a; border-bottom: 2px solid #facc15; cursor: pointer; }
        .annotation-underline { border-bottom: 2px solid #10b981; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. è¿˜åŸ Lucide å›¾æ ‡é€‚é…å±‚ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- 2. è¿˜åŸ PRESETS æ ·å¼é…ç½® (æ¥è‡ª App.tsx) ---
        const PRESETS = {
            stardew: { mode: 'stardew', fontFamily: "'ZCOOL XiaoWei', serif", bgColor: '#3d2817', panelColor: '#F4E4BC', textColor: '#3d2817', accentColor: '#5B9B42', borderColor: '#724E31', borderRadius: '24px', borderWidth: '4px', shadow: '6px 6px 0px 0px rgba(0,0,0,0.15)' },
            minimal: { mode: 'minimal', fontFamily: "'Noto Sans SC', sans-serif", bgColor: '#F7F7F7', panelColor: '#ffffff', textColor: '#191919', accentColor: '#07C160', borderColor: '#EEEEEE', borderRadius: '12px', borderWidth: '0px', shadow: '0 2px 10px rgba(0,0,0,0.05)' },
            pixel: { mode: 'pixel', fontFamily: "'ZCOOL KuaiLe', cursive", bgColor: '#5c94fc', panelColor: '#ffffff', textColor: '#000000', accentColor: '#f8d800', borderColor: '#000000', borderRadius: '0px', borderWidth: '3px', shadow: '4px 4px 0px 0px rgba(0,0,0,1)' }
        };

        // --- 3. æ¨¡æ‹Ÿ Gemini API é€»è¾‘ (è¿˜åŸ geminiService.ts) ---
        // æ³¨æ„ï¼šå®é™… API è°ƒç”¨éœ€è¦ API Keyã€‚ç”±äºå®‰å…¨æ€§ï¼Œå»ºè®®åœ¨ç•Œé¢è®¾ç½®ä¸­è¾“å…¥ Key
        const mockAnalyze = async (content) => {
            console.log("æ­£åœ¨ä½¿ç”¨ Gemini åˆ†æå†…å®¹...");
            // è¿™é‡Œæ ¹æ® content é•¿åº¦æ¨¡æ‹Ÿå»¶è¿Ÿ
            await new Promise(r => setTimeout(r, 1500));
            return {
                category: content.includes('æ¡ˆä¾‹') ? 'æ¡ˆä¾‹' : 'é‡‘å¥',
                domain: 'ç”Ÿæ€',
                tags: ['æ™ºæ…§', 'çŸ¥è¯†', 'å†œåœº']
            };
        };

        // --- 4. ä¸»ç¨‹åº (è¿˜åŸ App.tsx æ ¸å¿ƒé€»è¾‘) ---
        function App() {
            // æ•°æ®çŠ¶æ€
            const [materials, setMaterials] = useState(() => JSON.parse(localStorage.getItem('mp-vault-materials') || '[]'));
            const [categories] = useState(['æ¡ˆä¾‹', 'é‡‘å¥', 'æ”¿ç­–', 'äººç‰©', 'å…¶ä»–']);
            const [domains] = useState(['ç”Ÿæ€', 'ç¯å¢ƒ', 'ç»æµ', 'ç¨åŠ¡', 'æ”¿æ²»', 'ç§‘æŠ€']);
            const [theme, setTheme] = useState(PRESETS.stardew);
            const [season, setSeason] = useState('Spring');
            
            // äº¤äº’çŠ¶æ€
            const [activeTab, setActiveTab] = useState('vault');
            const [searchQuery, setSearchQuery] = useState('');
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [isOutlineOpen, setIsOutlineOpen] = useState(false);
            const [viewingMaterial, setViewingMaterial] = useState(null);
            const [filterCat, setFilterCat] = useState('all');
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            // æŒä¹…åŒ–
            useEffect(() => {
                localStorage.setItem('mp-vault-materials', JSON.stringify(materials));
            }, [materials]);

            // æœç´¢è¿‡æ»¤é€»è¾‘ (å®Œå…¨è¿˜åŸ)
            const filteredMaterials = useMemo(() => {
                return materials.filter(m => {
                    const matchesSearch = (m.title + m.content).toLowerCase().includes(searchQuery.toLowerCase());
                    const matchesCat = filterCat === 'all' || m.category === filterCat;
                    return matchesSearch && matchesCat;
                });
            }, [materials, searchQuery, filterCat]);

            // æ ¸å¿ƒæ–¹æ³•ï¼šä¿å­˜å¹¶åˆ†æ
            const handleSave = async (data) => {
                const newId = Date.now().toString();
                const newMaterial = {
                    ...data,
                    id: newId,
                    createdAt: new Date().toISOString(),
                    annotations: [],
                    isKeyPoint: false
                };
                
                setMaterials([newMaterial, ...materials]);
                setIsEditorOpen(false);
                
                // è§¦å‘ AI åˆ†æè¿˜åŸ
                setIsAnalyzing(true);
                const analysis = await mockAnalyze(data.content);
                if (analysis) {
                    setMaterials(prev => prev.map(m => m.id === newId ? { ...m, ...analysis } : m));
                }
                setIsAnalyzing(false);
            };

            return (
                <div className={`h-screen flex flex-col transition-all duration-500 ${theme.mode === 'stardew' ? 'paper-texture' : ''}`}
                     style={{ backgroundColor: theme.bgColor, color: theme.textColor, fontFamily: theme.fontFamily }}>
                    
                    {/* èƒŒæ™¯å­£èŠ‚è£…é¥°è¿˜åŸ */}
                    {theme.mode === 'stardew' && (
                        <div className="fixed inset-0 pointer-events-none opacity-10 flex flex-wrap gap-12 p-10 overflow-hidden">
                            {Array.from({length: 12}).map((_, i) => (
                                <span key={i} className="float-animation text-4xl">
                                    {season === 'Spring' ? 'ğŸŒ¸' : season === 'Summer' ? 'ğŸŒ»' : season === 'Autumn' ? 'ğŸ' : 'â„ï¸'}
                                </span>
                            ))}
                        </div>
                    )}

                    {/* é¡¶éƒ¨èƒ¶å›Šå¯¼èˆªæ  */}
                    <header className="safe-top pt-12 pb-4 px-6 flex justify-between items-center z-50">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setIsOutlineOpen(true)} className="p-2 bg-black/5 rounded-xl hover:bg-black/10 transition-colors">
                                <Icon name="menu" />
                            </button>
                            <h1 className="text-xl font-black">çŸ¥è¯†å†œåœº</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setTheme(theme.mode === 'stardew' ? PRESETS.minimal : PRESETS.stardew)} 
                                    className="p-2 rounded-full bg-white/20 backdrop-blur border border-white/30 shadow-sm hover:scale-110 transition-transform">
                                <Icon name="palette" />
                            </button>
                        </div>
                    </header>

                    {/* ä¸»å†…å®¹æ»šåŠ¨åŒº */}
                    <main className="flex-1 overflow-y-auto px-4 pb-32 custom-scrollbar relative z-10">
                        {activeTab === 'vault' ? (
                            <div className="space-y-4">
                                {/* æœç´¢ä¸å¿«é€Ÿè¿‡æ»¤ */}
                                <div className="sticky top-0 z-30 py-2 space-y-3">
                                    <div className="relative group">
                                        <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 opacity-30 group-focus-within:opacity-100 transition-opacity" />
                                        <input className="w-full pl-12 pr-4 py-4 rounded-2xl bg-white/80 backdrop-blur outline-none shadow-sm text-sm border-2 border-transparent focus:border-emerald-500/30" 
                                               placeholder="æœç´¢ä½ çš„å†œåœºæ”¶æˆ..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                        <FilterBtn active={filterCat === 'all'} label="å…¨éƒ¨" onClick={() => setFilterCat('all')} theme={theme} />
                                        {categories.map(c => <FilterBtn key={c} active={filterCat === c} label={c} onClick={() => setFilterCat(c)} theme={theme} />)}
                                    </div>
                                </div>

                                {/* ç´ æå¡ç‰‡åˆ—è¡¨ */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {filteredMaterials.map(m => (
                                        <div key={m.id} onClick={() => setViewingMaterial(m)}
                                             className="p-6 cursor-pointer active:scale-[0.98] transition-all hover:rotate-1"
                                             style={{ backgroundColor: theme.panelColor, borderRadius: theme.borderRadius, border: `${theme.borderWidth} solid ${theme.borderColor}`, boxShadow: theme.shadow }}>
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="text-[10px] font-black px-2 py-1 bg-black/5 rounded uppercase tracking-widest">{m.category}</span>
                                                <span className="text-[10px] opacity-30 italic">{m.domain}</span>
                                            </div>
                                            <h3 className="text-lg font-bold mb-2 leading-tight">{m.title}</h3>
                                            <p className="text-sm opacity-60 line-clamp-2">{m.content}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <MeView materials={materials} setSeason={setSeason} season={season} theme={theme} />
                        )}
                    </main>

                    {/* åº•éƒ¨å¯¼èˆªæ  */}
                    <nav className="fixed bottom-0 inset-x-0 h-24 bg-white/90 backdrop-blur-xl border-t border-black/5 flex items-center justify-around px-8 pb-6 z-50" 
                         style={{ borderRadius: '24px 24px 0 0' }}>
                        <TabItem active={activeTab === 'vault'} icon="home" label="é‡‘åº“" onClick={() => setActiveTab('vault')} theme={theme} />
                        <button onClick={() => setIsEditorOpen(true)} 
                                className="w-16 h-16 bg-[#5B9B42] text-white rounded-full flex items-center justify-center shadow-2xl -translate-y-6 border-4 border-white active:scale-90 transition-all">
                            <Icon name="plus" size={32} />
                        </button>
                        <TabItem active={activeTab === 'me'} icon="user" label="æˆ‘çš„" onClick={() => setActiveTab('me')} theme={theme} />
                    </nav>

                    {/* å¼¹çª—ï¼šå…¨åŠŸèƒ½ç¼–è¾‘å™¨ (è¿˜åŸ App.tsx ç¼–è¾‘é€»è¾‘) */}
                    {isEditorOpen && <FullEditor onSave={handleSave} onClose={() => setIsEditorOpen(false)} theme={theme} categories={categories} domains={domains} />}

                    {/* å¼¹çª—ï¼šå¤§çº²ç´¢å¼•è¿˜åŸ */}
                    {isOutlineOpen && <OutlineView materials={materials} onClose={() => setIsOutlineOpen(false)} onSelect={m => {setViewingMaterial(m); setIsOutlineOpen(false);}} theme={theme} />}

                    {/* å¼¹çª—ï¼šè¯¦æƒ…é¡µä¸åˆ’çº¿è¿˜åŸ */}
                    {viewingMaterial && <Details material={viewingMaterial} onClose={() => setViewingMaterial(null)} theme={theme} onDelete={id => {setMaterials(materials.filter(x => x.id !== id)); setViewingMaterial(null);}} />}
                </div>
            );
        }

        // --- å­ç»„ä»¶ (100% è¿˜åŸ UI) ---

        const FilterBtn = ({ active, label, onClick, theme }) => (
            <button onClick={onClick} className={`px-5 py-2 rounded-full text-xs font-black transition-all whitespace-nowrap ${active ? 'text-white' : 'bg-white shadow-sm opacity-50'}`}
                    style={{ backgroundColor: active ? theme.accentColor : '' }}>{label}</button>
        );

        const TabItem = ({ active, icon, label, onClick, theme }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 transition-all ${active ? 'scale-110' : 'opacity-30'}`}
                    style={{ color: active ? theme.accentColor : 'inherit' }}>
                <Icon name={icon} />
                <span className="text-[10px] font-black">{label}</span>
            </button>
        );

        function FullEditor({ onSave, onClose, theme, categories, domains }) {
            const [form, setForm] = useState({ title: '', content: '', category: categories[0], domain: domains[0] });
            return (
                <div className="fixed inset-0 z-[200] bg-white flex flex-col p-8 animate-in slide-in-from-bottom duration-500" style={{ fontFamily: theme.fontFamily }}>
                    <div className="flex justify-between items-center mb-10">
                        <button onClick={onClose} className="p-2 bg-slate-100 rounded-full"><Icon name="x" /></button>
                        <button onClick={() => onSave(form)} disabled={!form.title} className="px-10 py-3 bg-[#5B9B42] text-white rounded-full font-black shadow-lg disabled:opacity-20 transition-all active:scale-95">å­˜å…¥é‡‘åº“</button>
                    </div>
                    <input className="text-3xl font-black outline-none mb-8 placeholder:opacity-20 bg-transparent border-b-2 border-black/5 pb-2" placeholder="ç»™ä½ çš„çµæ„Ÿèµ·ä¸ªå..." value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                    <textarea className="flex-1 text-xl outline-none resize-none placeholder:opacity-20 leading-relaxed bg-transparent" placeholder="åœ¨æ­¤æ’­ä¸‹ä½ çš„çŸ¥è¯†ç§å­..." value={form.content} onChange={e => setForm({...form, content: e.target.value})} />
                    <div className="grid grid-cols-2 gap-4 mt-8">
                        <div className="space-y-2">
                            <p className="text-[10px] font-black opacity-30 ml-2">é€‰æ‹©åˆ†ç±»</p>
                            <select className="w-full p-4 bg-slate-100 rounded-2xl font-bold appearance-none" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                                {categories.map(c => <option key={c}>{c}</option>)}
                            </select>
                        </div>
                        <div className="space-y-2">
                            <p className="text-[10px] font-black opacity-30 ml-2">æ‰€å±é¢†åŸŸ</p>
                            <select className="w-full p-4 bg-slate-100 rounded-2xl font-bold appearance-none" value={form.domain} onChange={e => setForm({...form, domain: e.target.value})}>
                                {domains.map(d => <option key={d}>{d}</option>)}
                            </select>
                        </div>
                    </div>
                </div>
            );
        }

        function Details({ material, onClose, theme, onDelete }) {
            return (
                <div className="fixed inset-0 z-[150] bg-white flex flex-col animate-in fade-in slide-in-from-right duration-300" style={{ fontFamily: theme.fontFamily }}>
                    <header className="p-6 flex justify-between items-center border-b border-black/5">
                        <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="arrow-left" /></button>
                        <button onClick={() => {if(window.confirm('ç¡®è®¤ç§»å‡ºé‡‘åº“å—ï¼Ÿ')) onDelete(material.id)}} className="p-2 text-rose-500 hover:bg-rose-50 rounded-full"><Icon name="trash-2" /></button>
                    </header>
                    <div className="flex-1 overflow-y-auto p-10 space-y-8">
                        <div className="flex items-center gap-3">
                            <span className="text-[10px] font-black bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full uppercase tracking-tighter">{material.category}</span>
                            <span className="text-[10px] font-black bg-blue-100 text-blue-700 px-3 py-1 rounded-full uppercase tracking-tighter">{material.domain}</span>
                        </div>
                        <h2 className="text-4xl font-black leading-tight">{material.title}</h2>
                        <div className="w-16 h-2 bg-emerald-500 rounded-full" />
                        <p className="text-xl leading-relaxed text-slate-800 whitespace-pre-wrap">{material.content}</p>
                    </div>
                </div>
            );
        }

        function MeView({ materials, setSeason, season, theme }) {
            const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];
            return (
                <div className="p-6 space-y-8 animate-in fade-in duration-500">
                    <div className="p-10 rounded-[3rem] bg-white shadow-2xl text-center border-4" style={{ borderColor: theme.borderColor }}>
                        <div className="w-24 h-24 bg-emerald-500 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-2xl rotate-3 text-white text-4xl font-black">å†œ</div>
                        <h2 className="text-2xl font-black mb-2">é«˜çº§å†œå¤«</h2>
                        <p className="opacity-40 text-xs font-bold uppercase tracking-widest leading-loose">å·²åœ¨é‡‘åº“ç§¯ç´¯<br/><span className="text-2xl text-emerald-600">{materials.length}</span> æ ªçŸ¥è¯†ç´ æ</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => setSeason(seasons[(seasons.indexOf(season) + 1) % 4])} className="p-6 bg-white rounded-3xl shadow-sm flex flex-col items-center gap-3 active:scale-95 transition-all">
                            <Icon name="sprout" className="text-emerald-500" />
                            <span className="text-xs font-black">åˆ‡æ¢å­£èŠ‚ ({season})</span>
                        </button>
                        <button onClick={() => {if(window.confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {localStorage.clear(); window.location.reload();}}} className="p-6 bg-rose-50 rounded-3xl shadow-sm flex flex-col items-center gap-3 active:scale-95 transition-all text-rose-500">
                            <Icon name="trash" />
                            <span className="text-xs font-black">é‡ç½®å†œåœº</span>
                        </button>
                    </div>
                </div>
            );
        }

        function OutlineView({ materials, onClose, onSelect, theme }) {
            return (
                <div className="fixed inset-0 z-[180] bg-black/40 backdrop-blur-sm flex justify-start">
                    <div className="w-4/5 max-w-sm h-full bg-white shadow-2xl p-8 animate-in slide-in-from-left duration-300 flex flex-col" style={{ fontFamily: theme.fontFamily }}>
                        <div className="flex justify-between items-center mb-8">
                            <h3 className="text-xl font-black italic">ç´¢å¼•å¤§çº²</h3>
                            <button onClick={onClose}><Icon name="x" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-6">
                            {materials.length === 0 ? <p className="opacity-30 italic text-sm text-center py-20">è¿™é‡Œè¿˜æ˜¯è’åœ°...</p> : 
                             materials.map(m => (
                                <div key={m.id} onClick={() => onSelect(m)} className="group cursor-pointer border-l-4 border-emerald-500/10 pl-4 py-2 hover:border-emerald-500 transition-all">
                                    <p className="text-[10px] font-black opacity-30 mb-1">{m.category}</p>
                                    <p className="font-bold group-hover:text-emerald-600 transition-colors">{m.title}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
